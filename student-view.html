--- START OF FILE student-view.html ---

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaftalÄ±k ProgramÄ±n</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Sayfaya Ã¶zel temel stiller (Mevcut stiller...) */
        body { background-color: #f4f7f6; }
        header { background-color: #3498db; color: #fff; }
        main {
            max-width: 1200px;
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin: 25px auto;
            border-radius: 8px;
            overflow-x: auto;
        }
        hr { border: none; border-top: 1px solid #e0e0e0; margin: 15px 0 25px 0; } /* HR kenar boÅŸluÄŸunu ayarla */
        #program-baslik h2 { border: none; margin-bottom: 5px; color: #2c3e50; }
        #program-baslik p { margin-top: 0; color: #555; font-size: 1.1em; }
        .bos-hucre { color: #bbb; font-style: italic; font-size: 0.9em; text-align: center; padding: 10px; }

        #hata-mesaji {
            color: #e74c3c; font-weight: bold; text-align: center; margin-top: 20px;
            padding: 15px; background-color: #fadbd8; border: 1px solid #f1948a; border-radius: 4px;
        }

        /* Grid Tablo Stilleri (Mevcut stiller...) */
        #program-grid { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #aab7b8; table-layout: fixed; }
        #program-grid th,
        #program-grid td { border: 1px solid #aab7b8; padding: 0; text-align: center; vertical-align: top; min-height: 60px; position: relative; width: 14%; }
        #program-grid th { background-color: #5dade2; color: white; font-weight: bold; padding: 10px 5px; font-size: 1.05em; }
        #program-grid .task-item { padding: 8px 10px 12px 10px; margin: 0; text-align: left; position: relative; min-height: 50px; display: flex; flex-direction: column; justify-content: center; height: 100%; box-sizing: border-box; background-color: #e9f7ef; border-bottom: 1px solid #aab7b8; }
        #program-grid tr:last-child .task-item { border-bottom: none; }
        #program-grid .task-item strong { font-weight: 500; font-size: 0.85em; color: #34495e; display: block; margin-bottom: 3px; text-align: center; }
        #program-grid .task-aciklama pre { font-size: 0.95em; white-space: pre-wrap; word-wrap: break-word; font-family: inherit; margin: 0; padding: 0; background: none; border: none; color: #2c3e50; text-align: center; line-height: 1.3; }
        #program-grid .yapildi-buton { position: absolute; bottom: 3px; right: 3px; padding: 2px 5px; font-size: 0.65em; background-color: rgba(52, 152, 219, 0.7); color: white; border: none; border-radius: 3px; cursor: pointer; transition: background-color 0.3s ease; z-index: 1; }
        #program-grid .yapildi-buton:hover { background-color: rgba(41, 128, 185, 0.9); }
        #program-grid .task-item.task-tamamlandi { background-color: #f1f8e9; opacity: 0.7; }
        #program-grid .task-item.task-tamamlandi .task-aciklama,
        #program-grid .task-item.task-tamamlandi strong { color: #888; }
        #program-grid .task-item.task-tamamlandi .yapildi-buton { background-color: rgba(243, 156, 18, 0.7); }
        #program-grid .task-item.task-tamamlandi .yapildi-buton:hover { background-color: rgba(211, 84, 0, 0.9); }

        /* YENÄ°: Aksiyon DÃ¼ÄŸmeleri Stilleri */
        #program-actions {
            margin-top: 15px; /* BaÅŸlÄ±ÄŸÄ±n altÄ±ndaki boÅŸluk */
            margin-bottom: 10px; /* HR'nin Ã¼stÃ¼ndeki boÅŸluk */
            display: flex;
            gap: 10px; /* DÃ¼ÄŸmeler arasÄ± boÅŸluk */
            flex-wrap: wrap; /* KÃ¼Ã§Ã¼k ekranlarda dÃ¼ÄŸmelerin alta kaymasÄ±nÄ± saÄŸla */
            justify-content: center; /* DÃ¼ÄŸmeleri ortala */
        }
        #program-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.1s ease;
            color: white;
        }
         #program-actions button:hover {
             transform: translateY(-1px);
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }
        #copy-link-btn { background-color: #f39c12; } /* Turuncu */
        #copy-link-btn:hover { background-color: #e67e22; }
        #download-pdf-btn { background-color: #e74c3c; } /* KÄ±rmÄ±zÄ± */
        #download-pdf-btn:hover { background-color: #c0392b; }
        #download-excel-btn { background-color: #27ae60; } /* YeÅŸil */
        #download-excel-btn:hover { background-color: #229954; }

        /* Basit durum mesajÄ± stili */
        #status-message {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #27ae60; /* BaÅŸarÄ± iÃ§in yeÅŸil */
            min-height: 1.2em; /* DÃ¼zen kaymasÄ±nÄ± Ã¶nle */
        }
        #status-message.error { color: #e74c3c; } /* Hata iÃ§in kÄ±rmÄ±zÄ± */

    </style>
</head>
<body>
    <header><h1>HaftalÄ±k Ders ProgramÄ±n</h1></header>
    <main id="main-content"> <!-- PDF yakalama iÃ§in main'e ID ekle -->
        <div id="program-baslik"> <!-- BaÅŸlÄ±k JS ile eklenecek --> </div>

        <!-- YENÄ°: Aksiyon DÃ¼ÄŸmeleri -->
        <div id="program-actions">
            <button id="copy-link-btn" title="Bu program sayfasÄ±nÄ±n linkini panoya kopyala">ðŸ”— Linki Kopyala</button>
            <button id="download-pdf-btn" title="ProgramÄ± PDF dosyasÄ± olarak indir">ðŸ“„ PDF Ä°ndir</button>
            <button id="download-excel-btn" title="ProgramÄ± Excel dosyasÄ± olarak indir">ðŸ“Š Excel Ä°ndir</button>
        </div>
        <!-- YENÄ°: Durum MesajÄ± AlanÄ± -->
        <div id="status-message"></div>

        <hr>

        <table id="program-grid">
             <thead id="program-grid-head"></thead>
             <tbody id="program-grid-body"></tbody>
        </table>

        <div id="hata-mesaji" style="display: none;">Hata mesajÄ±...</div>
    </main>
    <footer><p>Â© 2023 Ã–ÄŸrenci Takip Sistemi</p></footer>

     <!-- YENÄ°: KÃ¼tÃ¼phane Scriptleri (jsPDF, html2canvas, SheetJS) -->
     <!-- Ã–NEMLÄ°: Ä°nternet baÄŸlantÄ±sÄ± gerektirir. Lokal kullanÄ±m iÃ§in dosyalarÄ± indirmeniz gerekir. -->
     <!-- jsPDF -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRjfL+pfBoNQTTNtaGTmWCvcP×“×¨dtFzjZ8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
     <!-- html2canvas -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVNR+adDxdrGWMloTiTRxuFpMGKzQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
     <!-- SheetJS (XLSX) -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvCbJn9PpdDA68zQAKPjJYKOTZSKGyL3pT4s9kKY6Sqcj2YtXZd/h/yCfbQow/D5hZCRvE/P2JkM7g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <script>
        // jspdf'i global olarak eriÅŸilebilir yap
        const { jsPDF } = window.jspdf;

        document.addEventListener('DOMContentLoaded', () => {
            // Mevcut deÄŸiÅŸken tanÄ±mlamalarÄ±...
            const programBaslikDiv = document.getElementById('program-baslik');
            const programGridHead = document.getElementById('program-grid-head');
            const programGridBody = document.getElementById('program-grid-body');
            const hataMesajiDiv = document.getElementById('hata-mesaji');
            const statusMessageDiv = document.getElementById('status-message'); // Durum mesajÄ± div'i

            // YENÄ°: DÃ¼ÄŸme Elementleri
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const downloadExcelBtn = document.getElementById('download-excel-btn');
            const mainContentElement = document.getElementById('main-content'); // PDF yakalama iÃ§in

            // --- Global program verisi (dÄ±ÅŸa aktarma fonksiyonlarÄ± iÃ§in gerekli) ---
            let currentProgramData = null;

            const daysOfWeek = ["Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma", "Cumartesi", "Pazar"];
            const dayKeyMap = { "Pazartesi": "pazartesi", "SalÄ±": "sali", "Ã‡arÅŸamba": "carsamba", "PerÅŸembe": "persembe", "Cuma": "cuma", "Cumartesi": "cumartesi", "Pazar": "pazar" };

            // Durum mesajÄ±nÄ± gÃ¶stermek iÃ§in yardÄ±mcÄ± fonksiyon
            function showStatus(message, isError = false) {
                statusMessageDiv.textContent = message;
                statusMessageDiv.className = isError ? 'error' : '';
                // Ä°steÄŸe baÄŸlÄ±: Bir sÃ¼re sonra gizle
                 setTimeout(() => {
                     statusMessageDiv.textContent = '';
                     statusMessageDiv.className = '';
                 }, 3000);
            }

            try {
                const hash = window.location.hash.substring(1);
                if (!hash) throw new Error("Linkte program verisi bulunamadÄ±.");

                const decodedString = decodeURIComponent(escape(atob(hash)));
                currentProgramData = JSON.parse(decodedString); // Veriyi global olarak sakla

                // BaÅŸlÄ±k (deÄŸiÅŸiklik yok)
                programBaslikDiv.innerHTML = `
                    <h2>Merhaba, ${currentProgramData.studentName || 'Ã–ÄŸrenci'}!</h2>
                    <p><strong>Program HaftasÄ±:</strong> ${formatWeek(currentProgramData.week) || 'BelirtilmemiÅŸ'}</p>
                `;

                // Grid OluÅŸturma (Mevcut mantÄ±k...)
                programGridHead.innerHTML = '';
                programGridBody.innerHTML = '';
                let maxTasks = 0;
                daysOfWeek.forEach(dayName => {
                    const dayKey = dayKeyMap[dayName];
                    const tasks = currentProgramData.days[dayKey] || [];
                    if (tasks.length > maxTasks) { maxTasks = tasks.length; }
                });

                 if (maxTasks === 0) {
                     const row = programGridBody.insertRow();
                     const cell = row.insertCell();
                     cell.colSpan = daysOfWeek.length;
                     cell.innerHTML = '<p class="bos-hucre" style="text-align: center; padding: 20px;">Bu hafta iÃ§in planlanmÄ±ÅŸ gÃ¶rev bulunmuyor.</p>';
                      // GÃ¶rev yoksa dÃ¼ÄŸmeleri gizle
                      copyLinkBtn.style.display = 'none';
                      downloadPdfBtn.style.display = 'none';
                      downloadExcelBtn.style.display = 'none';
                      return; // Daha fazla iÅŸlem yapmayÄ± durdur
                 }


                const headerRow = programGridHead.insertRow();
                daysOfWeek.forEach(dayName => {
                    const th = document.createElement('th'); th.textContent = dayName; headerRow.appendChild(th);
                });

                for (let i = 0; i < maxTasks; i++) {
                    const taskRow = programGridBody.insertRow();
                    daysOfWeek.forEach(dayName => {
                        const cell = taskRow.insertCell(); const dayKey = dayKeyMap[dayName]; const tasks = currentProgramData.days[dayKey] || []; const task = tasks[i];
                        if (task) { cell.innerHTML = renderTaskContent(task); } else { cell.innerHTML = `<div class="bos-hucre">-</div>`; }
                    });
                }

                // GÃ¶rev Tamamlama DÃ¼ÄŸmeleri iÃ§in Olay Dinleyici (Mevcut mantÄ±k - delegation ile)
                programGridBody.addEventListener('click', handleTaskDoneClick);

                 // --- YENÄ°: DÃ¼ÄŸme Olay Dinleyicileri ---
                 copyLinkBtn.addEventListener('click', handleCopyLink);
                 downloadPdfBtn.addEventListener('click', handleDownloadPdf);
                 downloadExcelBtn.addEventListener('click', handleDownloadExcel);


            } catch (error) {
                // Mevcut hata yÃ¶netimi...
                 console.error("Program yÃ¼klenirken hata:", error);
                 programBaslikDiv.innerHTML = ''; programGridHead.innerHTML = ''; programGridBody.innerHTML = '<tr><td colspan="7">Program yÃ¼klenemedi. LÃ¼tfen linki kontrol edin veya Ã¶ÄŸretmeninizle iletiÅŸime geÃ§in.</td></tr>'; hataMesajiDiv.textContent = 'Program yÃ¼klenirken bir hata oluÅŸtu veya bu link geÃ§ersiz.'; hataMesajiDiv.style.display = 'block';

                 // Hata durumunda aksiyon dÃ¼ÄŸmelerini devre dÄ±ÅŸÄ± bÄ±rak/gizle
                 if(copyLinkBtn) copyLinkBtn.style.display = 'none';
                 if(downloadPdfBtn) downloadPdfBtn.style.display = 'none';
                 if(downloadExcelBtn) downloadExcelBtn.style.display = 'none';
            }
        });

        /** GÃ¶revin HTML iÃ§eriÄŸini oluÅŸturur (hÃ¼cre iÃ§ine yerleÅŸtirilecek - deÄŸiÅŸiklik yok) */
        function renderTaskContent(task) {
            if (!task.taskId) { return '<div class="task-item">ID Hata!</div>'; }
            const taskKey = `taskStatus_${task.taskId}`; const isDone = localStorage.getItem(taskKey) === 'true'; const doneClass = isDone ? 'task-tamamlandi' : ''; const buttonText = isDone ? 'Geri Al' : 'YapÄ±ldÄ±';
            return `<div class="task-item ${doneClass}" id="task-${task.taskId}">${task.bookTitle ? `<strong>${task.bookTitle.toUpperCase()}</strong>` : ''}<div class="task-aciklama"><pre>${task.description || '(AÃ§Ä±klama yok)'}</pre></div><button class="yapildi-buton" data-task-id="${task.taskId}">${buttonText}</button></div>`;
        }

        /** GÃ¶rev tamamlama butonu tÄ±klama olayÄ±nÄ± yÃ¶netir (Event Delegation - deÄŸiÅŸiklik yok) */
        function handleTaskDoneClick(event) {
             if (!event.target.classList.contains('yapildi-buton')) return;
             const button = event.target; const taskId = button.dataset.taskId; const taskDiv = button.closest('.task-item'); const taskKey = `taskStatus_${taskId}`;
             if (!taskDiv || !taskId) return;
             const isCurrentlyDone = taskDiv.classList.contains('task-tamamlandi'); const newDoneStatus = !isCurrentlyDone;
             taskDiv.classList.toggle('task-tamamlandi', newDoneStatus); button.textContent = newDoneStatus ? 'Geri Al' : 'YapÄ±ldÄ±'; localStorage.setItem(taskKey, newDoneStatus.toString());
        }

         /** HaftayÄ± formatlar (deÄŸiÅŸiklik yok) */
         function formatWeek(weekString) { if (!weekString || !weekString.includes('-W')) return weekString; try { const parts = weekString.split('-W'); return `${parts[0]} YÄ±lÄ±nÄ±n ${parts[1]}. HaftasÄ±`; } catch (e) { return weekString; } }


        // --- YENÄ°: Aksiyon DÃ¼ÄŸmesi YÃ¶neticileri ---

        /** Link Kopyalama Ä°ÅŸlevi */
        function handleCopyLink() {
            const link = window.location.href;
            navigator.clipboard.writeText(link)
                .then(() => {
                     showStatus("Program linki panoya kopyalandÄ±!");
                })
                .catch(err => {
                    console.error('Link kopyalanamadÄ±:', err);
                    showStatus("Hata: Link kopyalanamadÄ±.", true);
                    // Yedek (prompt - isteÄŸe baÄŸlÄ±)
                    // window.prompt("Linki kopyalamak iÃ§in: Ctrl+C, Enter", link);
                });
        }

         /** PDF Ä°ndirme Ä°ÅŸlevi */
        function handleDownloadPdf() {
             const { jsPDF } = window.jspdf;
             const elementToCapture = document.getElementById('main-content'); // TÃ¼m ana alanÄ± yakala
             const statusMessageDiv = document.getElementById('status-message');
              const pdfButton = document.getElementById('download-pdf-btn');

             if (!elementToCapture || typeof html2canvas === 'undefined' || typeof jsPDF === 'undefined') {
                showStatus("Hata: PDF oluÅŸturma kÃ¼tÃ¼phaneleri yÃ¼klenemedi.", true);
                 console.error("jsPDF veya html2canvas yÃ¼klenemedi");
                 return;
             }
            pdfButton.disabled = true; // Ä°ÅŸlem sÄ±rasÄ±nda dÃ¼ÄŸmeyi devre dÄ±ÅŸÄ± bÄ±rak
            showStatus("PDF oluÅŸturuluyor, lÃ¼tfen bekleyin...");


             // Yakalama sÄ±rasÄ±nda aksiyon dÃ¼ÄŸmelerini gizle
             document.getElementById('program-actions').style.visibility = 'hidden';

             html2canvas(elementToCapture, {
                 scale: 2, // Daha iyi kalite iÃ§in Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ artÄ±r
                 useCORS: true, // EÄŸer dÄ±ÅŸarÄ±dan resim/font varsa (burada gerekmeyebilir)
                 logging: false,
                 onclone: (clonedDoc) => {
                     // Gerekirse, kopyalanan dokÃ¼manÄ± render etmeden Ã¶nce dÃ¼zenle
                     // Ã–rneÄŸin, dÃ¼ÄŸmeleri klondan aÃ§Ä±kÃ§a kaldÄ±r
                     const clonedActions = clonedDoc.getElementById('program-actions');
                     if (clonedActions) clonedActions.style.display = 'none';
                      const clonedStatus = clonedDoc.getElementById('status-message');
                     if (clonedStatus) clonedStatus.style.display = 'none';
                 }
             }).then(canvas => {
                 const imgData = canvas.toDataURL('image/png');
                 const pdf = new jsPDF({
                     orientation: 'landscape', // Yatay daha iyiyse
                     unit: 'pt', // points
                      format: 'a4' // Standart A4 boyutu
                 });

                 const pdfWidth = pdf.internal.pageSize.getWidth();
                 const pdfHeight = pdf.internal.pageSize.getHeight();
                 const imgWidth = canvas.width;
                 const imgHeight = canvas.height;

                 // En boy oranÄ±nÄ± hesapla
                 const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);

                 // Ã–lÃ§eklenmiÅŸ boyutlarÄ± hesapla
                 const scaledWidth = imgWidth * ratio * 0.95; // Kenar boÅŸluklarÄ± iÃ§in geniÅŸliÄŸin %95'ini kullan
                 const scaledHeight = imgHeight * ratio * 0.95; // Kenar boÅŸluklarÄ± iÃ§in yÃ¼ksekliÄŸin %95'ini kullan

                 // Resmi ortala
                 const xPos = (pdfWidth - scaledWidth) / 2;
                 const yPos = (pdfHeight - scaledHeight) / 2;

                 pdf.addImage(imgData, 'PNG', xPos, yPos, scaledWidth, scaledHeight);

                  const filename = generateFilename('pdf');
                 pdf.save(filename);
                 showStatus("PDF baÅŸarÄ±yla indirildi!");

             }).catch(err => {
                  console.error("PDF oluÅŸturma hatasÄ±:", err);
                  showStatus("Hata: PDF oluÅŸturulamadÄ±.", true);
             }).finally(() => {
                // Yakalama denemesinden sonra dÃ¼ÄŸmeleri tekrar gÃ¶ster
                 document.getElementById('program-actions').style.visibility = 'visible';
                  pdfButton.disabled = false; // DÃ¼ÄŸmeyi tekrar etkinleÅŸtir
             });
        }

         /** Excel Ä°ndirme Ä°ÅŸlevi */
         function handleDownloadExcel() {
              const excelButton = document.getElementById('download-excel-btn');
             if (typeof XLSX === 'undefined') {
                 showStatus("Hata: Excel oluÅŸturma kÃ¼tÃ¼phanesi yÃ¼klenemedi.", true);
                 console.error("XLSX (SheetJS) yÃ¼klenemedi");
                 return;
             }
              if (!currentProgramData) {
                 showStatus("Hata: Program verisi bulunamadÄ±.", true);
                  return;
              }

              excelButton.disabled = true; // DÃ¼ÄŸmeyi devre dÄ±ÅŸÄ± bÄ±rak
             showStatus("Excel dosyasÄ± oluÅŸturuluyor...");

              try {
                 // Veriyi Array of Arrays formatÄ±nda hazÄ±rla
                 const dataForSheet = [];

                  // 1. BaÅŸlÄ±k SatÄ±rÄ± (GÃ¼nler)
                  const daysOfWeek = ["Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma", "Cumartesi", "Pazar"];
                  dataForSheet.push(daysOfWeek);

                  // 2. GÃ¶rev SatÄ±rlarÄ±
                  let maxTasks = 0;
                  const dayKeyMap = { "Pazartesi": "pazartesi", "SalÄ±": "sali", "Ã‡arÅŸamba": "carsamba", "PerÅŸembe": "persembe", "Cuma": "cuma", "Cumartesi": "cumartesi", "Pazar": "pazar" };
                   daysOfWeek.forEach(dayName => {
                      const dayKey = dayKeyMap[dayName];
                       const tasks = currentProgramData.days[dayKey] || [];
                       if (tasks.length > maxTasks) { maxTasks = tasks.length; }
                   });

                 for (let i = 0; i < maxTasks; i++) {
                      const rowData = [];
                     daysOfWeek.forEach(dayName => {
                           const dayKey = dayKeyMap[dayName];
                          const tasks = currentProgramData.days[dayKey] || [];
                          const task = tasks[i];
                          if (task) {
                                // Kitap baÅŸlÄ±ÄŸÄ±nÄ± ve aÃ§Ä±klamayÄ± Excel hÃ¼cresi iÃ§in birleÅŸtir
                               const cellText = (task.bookTitle ? `${task.bookTitle.toUpperCase()}\n` : '') + (task.description || '');
                               rowData.push(cellText.trim());
                           } else {
                               rowData.push(""); // Daha az gÃ¶revi olan gÃ¼nler iÃ§in boÅŸ hÃ¼cre
                          }
                      });
                      dataForSheet.push(rowData);
                  }

                  // Ã‡alÄ±ÅŸma SayfasÄ± ve Ã‡alÄ±ÅŸma KitabÄ± OluÅŸtur
                 const ws = XLSX.utils.aoa_to_sheet(dataForSheet);

                  // --- Ä°steÄŸe BaÄŸlÄ±: SÃ¼tun GeniÅŸlikleri ---
                 // Ä°Ã§eriÄŸe gÃ¶re geniÅŸlikleri tahmin et (bu temel dÃ¼zeydedir, iyileÅŸtirme gerekebilir)
                 const colWidths = daysOfWeek.map((_, colIndex) => {
                     let maxLen = 0;
                     dataForSheet.forEach((row) => {
                         const cellContent = row[colIndex] || "";
                          // GeniÅŸliÄŸi tahmin ederken yeni satÄ±r karakterlerini dikkate al
                          const lines = cellContent.split('\n');
                          const longestLine = lines.reduce((max, line) => Math.max(max, line.length), 0);
                         if (longestLine > maxLen) maxLen = longestLine;
                     });
                     // Biraz dolgu, min/maks geniÅŸlik ver
                      return { wch: Math.max(15, Math.min(50, maxLen + 5)) };
                 });
                  ws['!cols'] = colWidths;
                  // --- Ä°steÄŸe BaÄŸlÄ±: SatÄ±r YÃ¼kseklikleri (Daha Zor) ---
                  // Otomatik satÄ±r yÃ¼ksekliÄŸi genellikle varsayÄ±landÄ±r, ancak gerekirse belirli yÃ¼kseklikleri ayarlayabilirsiniz.


                 const wb = XLSX.utils.book_new();
                 XLSX.utils.book_append_sheet(wb, ws, "HaftalÄ±k Program"); // Sayfa adÄ±

                 // Ä°ndirmeyi tetikle
                 const filename = generateFilename('xlsx');
                 XLSX.writeFile(wb, filename);
                 showStatus("Excel dosyasÄ± baÅŸarÄ±yla indirildi!");

              } catch (err) {
                   console.error("Excel oluÅŸturma hatasÄ±:", err);
                   showStatus("Hata: Excel dosyasÄ± oluÅŸturulamadÄ±.", true);
               } finally {
                   excelButton.disabled = false; // DÃ¼ÄŸmeyi tekrar etkinleÅŸtir
              }
        }


         /** Program verisine gÃ¶re bir dosya adÄ± oluÅŸturur */
        function generateFilename(extension) {
             let name = "Program";
             if (currentProgramData) {
                  name = `Program_${currentProgramData.studentName || 'Ogrenci'}_${currentProgramData.week || 'Haftalik'}`;
             }
             // Temel temizleme
             name = name.replace(/[^a-z0-9_\-]/gi, '_').replace(/_+/g, '_');
              return `${name}.${extension}`;
         }


    </script>

</body>
</html>
--- END OF FILE student-view.html ---
